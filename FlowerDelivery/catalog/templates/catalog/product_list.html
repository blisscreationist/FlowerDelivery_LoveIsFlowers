<!-- catalog/templates/catalog/product_list.html -->

{% extends 'flowerdelivery/base.html' %}
{% load my_custom_filters %}
{% block content %}
<div class="container mt-4">
    <h1>{{ category.name }}</h1>

    <!-- Фильтр по цене -->
    <form method="get" class="form-inline mb-4">
        <div class="form-group mr-2">
            <label for="price_min" class="mr-2">Мин. цена:</label>
            <input type="number" id="price_min" name="price_min" class="form-control" value="{{ price_min|default_if_none:'' }}">
        </div>
        <div class="form-group mr-2">
            <label for="price_max" class="mr-2">Макс. цена:</label>
            <input type="number" id="price_max" name="price_max" class="form-control" value="{{ price_max|default_if_none:'' }}">
        </div>
        <button type="submit" class="btn btn-custom">Фильтровать</button>
    </form>
 <div class="button-container">
    <a class="btn btn-primary btn-lg" href="{% url 'category_list' %}" role="button">Вернуться в каталог</a>
</div>
    <br>
    <div class="row">
        {% for product in products %}
            <div class="col-md-4">
                <article class="card mb-4 shadow-sm">
                    <div class="card__preview">
                        <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
                        <div class="card__price">{{ product.price }} руб.</div>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">{{ product.description }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <!-- Форма добавления в корзину -->
                            <form method="post" action="{% url 'add_to_cart' %}" class="form-inline">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                <input type="number" name="quantity" value="1" min="1" class="form-control mr-2" style="width: 60px;">
                                <button type="submit" class="btn btn-primary btn-sm">В корзину</button>
                            </form>
                        </div>
                        <div class="mt-2">
                            <strong>Рейтинг: {{ product_ratings|get_item:product.id|default_if_none:"0"|floatformat:2 }}</strong>
                        </div>
                    </div>

                    <!-- Отзывы продукта -->
                    <div class="card-footer">
                        <h6>Отзывы:</h6>
                        <p>Количество отзывов: {{ product_review_counts|get_item:product.id|default_if_none:"0" }}</p>
                        <div id="reviews-{{ product.id }}" class="reviews-container" style="display: none;">
                            {% with product_reviews=product_reviews|dictsort:"id" %}
                                {% for review in product_reviews|dictsort:"id"|slice:":product.id" %}
                                    {% if review.product.id == product.id %}
                                        <div>
                                            <strong>{{ review.user.username }} (Рейтинг: {{ review.rating }})</strong>
                                            <p>{{ review.review_text }}</p>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        </div>
                        <button class="btn btn-custom btn-link toggle-reviews" data-product-id="{{ product.id }}">Смотреть все отзывы</button>


<!-- Форма для оставления отзыва -->
<form method="post" action="{% url 'submit_review' product.id %}" class="mt-3">
    {% csrf_token %}
    <div class="form-group">
        <label for="rating-{{ product.id }}">Рейтинг:</label>
        <div class="star-rating" data-product-id="{{ product.id }}">
            {% for i in "12345" %}
                <span class="star" data-value="{{ i }}">&#9733;</span>
            {% endfor %}
            <input type="hidden" id="rating-{{ product.id }}" name="rating" value="0" required>
        </div>
    </div>
    <div class="form-group">
        <label for="review_text">Отзыв:</label>
        <textarea id="review_text" name="review_text" class="form-control" rows="3" required></textarea>
    </div>
    <button type="submit" class="btn btn-custom">Оставить отзыв</button>
</form>
                    </div>
                </article>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Стили для карточек и кнопок -->
<style>
:root {
    --primary: #111926;
    --white: #fff;
    --background: #F8F8FF;
    --gray: #D3D3D3;
    --text: #262626;
}

.card {
    background: var(--white);
    border-radius: 1.5rem;
    box-shadow: rgba(0, 0, 0, 0.1) 0px 2px 6px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.card__preview {
    position: relative;
    overflow: hidden;
}

.card__preview img {
    width: 100%;
    height: auto;
    object-fit: cover;
}

.card__price {
    background-color: var(--white);
    color: var(--text);
    z-index: 1;
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    font-weight: bold;
    padding: 0.25rem 0.5rem;
    border-radius: 0.5rem;
}

.card-body {
    padding: 1.25rem;
    color: var(--text);
}

.card-title {
    margin: 0.5rem 0;
}

.star-rating {
    display: flex;
    flex-direction: row;
}

.star {
    font-size: 2rem;
    color: gray;
    cursor: pointer;
}

.star.hover,
.star.selected {
    color: gold;
}

/* Новый стиль для кнопок */
.btn-custom {
    background-color: #D3D3D3;
    border: 1px solid var(--gray);
    color: var(--text);
    border-radius: 0.25rem;
    padding: 0.375rem 0.75rem;
    transition: background-color 0.3s, color 0.3s;
}

.btn-custom:hover {
    background-color: var(--gray);
    color: var(--white);
}

.btn-custom:active {
    background-color: var(--text);
    color: var(--white);
}

.button-container {
    display: flex; /* Используем flexbox для центрирования */
    justify-content: center; /* Центрируем кнопку по горизонтали */
    margin-top: 1.5rem; /* Отступ сверху для кнопки */
}
</style>

<!-- Скрипты для звездного рейтинга и скрытия отзывов -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Скрытие и показ отзывов
    document.querySelectorAll('.toggle-reviews').forEach(function(button) {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const reviewsContainer = document.getElementById('reviews-' + productId);

            if (reviewsContainer.style.display === 'none') {
                reviewsContainer.style.display = 'block';
                this.textContent = 'Скрыть отзывы';
            } else {
                reviewsContainer.style.display = 'none';
                this.textContent = 'Смотреть все отзывы';
            }
        });
    });

    // Звездный рейтинг
    document.querySelectorAll('.star-rating').forEach(function(starRating) {
        const ratingInput = starRating.querySelector('input[type="hidden"]');
        const stars = starRating.querySelectorAll('.star');

        stars.forEach(function(star) {
            star.addEventListener('click', function() {
                const ratingValue = parseInt(this.getAttribute('data-value'));
                ratingInput.value = ratingValue;

                // Сброс всех звезд
                stars.forEach(s => s.classList.remove('selected'));

                // Выделение нужного количества звезд
                stars.forEach((s, index) => {
                    if (index < ratingValue) {
                        s.classList.add('selected');
                    }
                });
            });

            star.addEventListener('mouseover', function() {
                stars.forEach(s => s.classList.remove('hover'));

                const hoverValue = parseInt(this.getAttribute('data-value'));
                stars.forEach((s, index) => {
                    if (index < hoverValue) {
                        s.classList.add('hover');
                    }
                });
            });

            star.addEventListener('mouseout', function() {
                stars.forEach(s => s.classList.remove('hover'));
            });
        });
    });
});
</script>
{% endblock %}


